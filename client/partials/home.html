<div ng-controller="HomeCtrl">
    <div class="guide">

        <div id="step1">
            <div id = "step1_Img"></div>
            <div id = "step1_Txt"> <h3>Working Station</h3>Here You Can Build Your Own Tree</div>
            <button id="next"type="button" class="btn btn-default" aria-label="right Align">
                Next
            </button>

        </div>
       <div id="step2">
            <div id = "step2_Img"></div>
            <div id = "step2_Txt"><h3>Intermediate Station</h3>Here You Can Search In Your Chosen Folders</div>


        </div>
         <div id="step3">
            <div id = "step3_Img"></div>
            <div id = "step3_Txt"><h3>Computer's File Structure</h3></div>

        </div>
        <div id="step4">
            <div id = "step4_Img"></div>
            <div id = "step4_Txt">You Can Create Your Own Root Folder</div>
            <button id="next4"type="button" class="btn btn-default" aria-label="right Align">
                Next
            </button>
        </div>
        <div id="step5">
            <div id = "step5_Img"></div>
            <div id = "step5_Txt">Drag & Drop Files and Folders</div>
            <button id="next5"type="button" class="btn btn-default" aria-label="right Align">
                Next
            </button>

        </div>
        <div id="step6">
            <div id = "step6_Img"></div>
            <div id = "step6_Txt">Reset Your Search and Working Stations</div>
            <button id="next6"type="button" class="btn btn-default" aria-label="right Align">
                Next
            </button>

        </div>
     <!--   <div id="step7">
            <div id = "step7_Img"></div>
            <div id = "step7_Txt"> You can create your root folder</div>
            <button id="next7"type="button" class="btn btn-default" aria-label="right Align">
                Step 8
            </button>

        </div>
        <div id="step8">
            <div id = "step8_Img"></div>
            <div id = "step8_Txt">Drag & Drop files and folders</div>

        </div>-->

    </div>
    <div class="toolBar">
      <div class="btn-toolbar" role="toolbar">

          <form id="s">
              <div class="btn-group" id="copytoRight">
                  <button type="button" id="copyto" class="btn btn-default" aria-label="left Align">
                      <span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span>
                  </button>
              </div>
              <div class="btn-group" id="buildTreeRight">
                  <button type="button" id="buildTree" class="btn btn-default" aria-label="left Align">
                      <span class="glyphicon glyphicon-buildTree" aria-hidden="true"></span>
                  </button>
              </div>
              <button type="submit" id="submit" class="btn btn-default"  aria-label="left Align">Search</button>
              <input type="search" class="ng-tree-search" placeholder="Search" id="q" />

          </form>
          <div class="btn-group">
              <button id="create"type="button" class="btn btn-default" aria-label="left Align">
                  <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
              </button>
          </div>
          <div class="btn-group">
              <button id="save" type="button" class="btn btn-default" aria-label="right Align" data-toggle="modal" data-target="#savedtreemodal">
                  <span id="savechange" class="glyphicon glyphicon-floppy-save" aria-hidden="true"></span>
              </button>
          </div>
          <div class="btn-group">
              <div class="size">
                  <button type="button" class="btn btn-default field" name="test"  id="open" aria-label="right Align"  >
                      <span  class="glyphicon glyphicon-folder-open" aria-hidden="true"></span>
                    </button>
                      <ul class="list">
                  </ul>
              </div>
          </div>

          <div class="btn-group">
              <button class='btn btn-danger btn-default' id="reset" type="submit" name="remove_levels" aria-label="left Align" value="delete"><span class="fa fa-times"></span> Reset</button>
          </div>

          <!--/*---------localstorage View list-------*/-->

      </div>
        <h3 id="buildTreeHeader">{{buildHeader}}</h3>
     </div>

    <div class="row">
        <div class="col-md-3 tree-browser ">
          <js-tree tree-events="select_node:nodeSelected"  tree-events="dnd_move:dndMove" tree-ajax="/api/tree" tree-core="tree_core"  tree-rules = "tree_rules" tree-plugins="dnd,state,types"></js-tree>
        </div>
        <div class="dynNav col-md-3">

            <p>
                <div id="messagesAlert"></div>

                <!-- Nav tabs from Bootstrap 3 -->
                <ul id="myTab" class="nav nav-tabs" role="tablist">
                    <li id="li1" class="active"><a href="#" role="tab" data-toggle="tab">Tab 1</a></li>
                    <li id="li2" class=""><a href="#" role="tab" data-toggle="tab">Tab 2</a></li>

                    <li id="last"><a href="#"><span class="glyphicon glyphicon-plus"></span> Add Tab</a></li>
                </ul>
                </p>
            <p>
                    <!-- Tab panes from Bootstrap 3 -->
                <div class="tab-content">
                    <div class="tab-pane fade in active data-tree" tree-ajax="/api/tree" id="tab1"><p>Content tab 1</p></div>
                </div>
                </p>

        </div>
        <div class="dynNav col-md-6">

            <p>
                <div id="messagesAlert2"></div>

                <!-- Nav tabs from Bootstrap 3 -->
                <ul id="myTab2" class="nav nav-tabs" role="tablist">
                    <li id="lii1" class="active"><a href="#tab" role="tab" data-toggle="tab">Tab 1</a></li>
                    <li id="lii2" class=""><a href="#tab" role="tab" data-toggle="tab">Tab 2</a></li>

                    <li id="last2"><a href="#AddTab"><span class="glyphicon glyphicon-plus"></span> Add Tab</a></li>
                </ul>
            </p>
            <p>
                    <!-- Tab panes from Bootstrap 3 -->
                <div class="tab-content">
                    <div class="tab-pane fade in active file-viewer" id="tab2"><p>Content tab 1</p></div>
                </div>
            </p>

        </div>
        <!-- Modal -->
        <div class="modal fade" id="savedtreemodal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Save Tree</h4>
                    </div>
                    <div class="modal-body">
                        <form action="post">
                            <div class="form-group">
                                <label for="treeName" class="control-label">Tree Name:</label>
                                <input type="text" name="treeName" class="form-control" id="treeName">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button data-dismiss="modal" id="saveName" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </div>
        </div>


       <!-- <div class="bs-example col-md-3 ">
            <ul class="nav nav-tabs " id="myTab">
                <li class="active"><a href="#sectionA">Tab 1</a></li>
                <li><a href="#sectionB">+</a></li>
            </ul>
            <div class="tab-content ">
                <div id="sectionA" class="tab-pane fade in active">
                    <div class=" data-tree "  >
                        <js-tree id-="alltree" tree-ajax="/api/tree"></js-tree>


                    </div>
                </div>
                <div id="sectionB" class="tab-pane fade">
                    <div class="data-tree">


                    </div>
                </div>

            </div>
        </div>

        <div class="bs-example col-md-6 ">
            <ul class="nav nav-tabs " id="myTab2">
                <li class="active"><a href="#sectionA">Tab 1</a></li>
                <li><a href="#sectionB">+</a></li>
            </ul>
            <div class="tab-content ">
                <div id="sectionC" class="tab-pane fade in active">
                    <div class="file-viewer">
                        <pre><code>{{fileViewer}}</code></pre>
                    </div>
                </div>
                <div id="sectionD" class="tab-pane fade">
                    <div class=" file-viewer">
                        <pre><code>{{fileViewer}}</code></pre>
                    </div>
                </div>

            </div>
        </div>-->


    </div>

</div>
<script>
    $(document).ready(function() {

       /* jQuery(document).on("dnd_start.vakata", function (e, data) {
            console.log("here");
            var xhr = ("XMLHttpRequest" in window) ? new XMLHttpRequest() : new ActiveXObject("Msxml3.XMLHTTP");


            var treeNode = data.element.getAttribute("id");
            //var _l = data.node.li_attr;
            xhr.open("GET", 'api/tree?id='+treeNode, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4)  {
                    var serverResponse = xhr.responseText;
                }
            };
            xhr.send(null);
            console.log(xhr);
             console.log(treeNode);

            debugger
        });*/
        $(function(){
            $('.size').styleddropdown();
        });
        (function($){
            $.fn.styleddropdown = function(){
                return this.each(function(){
                    var obj = $(this)
                    obj.find('.field').click(function() { //onclick event, 'list' fadein
                        obj.find('.list').fadeIn(400);

                        $(document).keyup(function(event) { //keypress event, fadeout on 'escape'
                            if(event.keyCode == 27) {
                                obj.find('.list').fadeOut(400);
                            }
                        });

                        obj.find('.list').hover(function(){ },
                                function(){
                                    $(this).fadeOut(400);
                                });
                    });

                    obj.find('.list li').click(function() { //onclick event, change field value with selected 'list' item and fadeout 'list'
                        obj.find('.field')
                                .val($(this).html())
                                .css({
                                    'background':'#fff',
                                    'color':'#333'
                                });
                        obj.find('.list').fadeOut(400);
                    });
                });
            };
        })(jQuery);
        $('#savedtreemodal').on('shown.bs.modal', function () {

            $('#savedtreemodal').focus();

        })



        $(function () {

        $('#myTab li[id=last]').on('click', function () { // Click event on the "Add Tab" button
            console.log('last');
            var nbrLiElem = ($('ul#myTab li').length) - 1; // Count how many <li> there are (minus 1 because one <li> is the "Add Tab" button)
            console.log(nbrLiElem);
            // Add a <li></li> line before the last-child
            // Including the complete structure: the li ID, the <a href=""></a> etc... check the Bootstrap togglable tabs structure
            $('ul#myTab li:last-child').before('<li id="li' + (nbrLiElem + 1) + '"><a href="#tab' + (nbrLiElem + 1) + '" role="tab" data-toggle="tab">Tab ' + (nbrLiElem + 1) + ' <button type="button" class="btn btn-warning btn-xs" onclick="removeTab(' + (nbrLiElem + 1) + ');"><span class="glyphicon glyphicon-remove"></span></button></a>');

            // Add a <div></div> markup after the last-child of the <div class="tab-content">
            $('div.tab-content div:last-child').after('<div class="tab-pane fade data-tree" id="tab' + (nbrLiElem + 1) + '"><p>Content tab ' + (nbrLiElem + 1) + '</p></div>');
            nbrLiElem = nbrLiElem + 1; // 1 more element in the tab system
            $('#displayElem').html(nbrLiElem); // This line is not required (I just display, inside the <div id="messagesAlert"></div> markup, how many tabs there is)
        });
    });

    function removeTab(liElem) { // Function remove tab with the <li> number
        if (confirm("Are you sure?")) { // Display "Are you sure message" and wait for you to press "Ok"
            $('ul#myTab > li#li' + liElem).fadeOut(1000, function () {
                $(this).remove(); // Remove the <li></li> with a fadeout effect
                $('#messagesAlert').text(''); // Empty the <div id="messagesAlert"></div>
            });

            $('div.tab-content div#tab' + liElem).remove(); // Also remove the correct <div> inside <div class="tab-content">

            $('ul#myTab > li').not('#last').not('#li' + liElem).each(function(i){ // Select all <li> from <ul id="myTab"> except the last (with is the "Add Tab" button) and without the one we deleted
                var getAttr = $(this).attr('id').split('li'); // We get the <li> div attribute
                $('ul#myTab li#li' + getAttr[1]).attr('id', 'li' + (i + 1)); // We change the div attribute of all <li>: the first is 1, then 2, then 3...

                var tabContent = 'Tab ' + (i + 1); //
                if (getAttr[1] != 1) tabContent += ' <button type="button" class="btn btn-warning btn-xs" onclick="removeTab(' + (i + 1) + ');"><span class="glyphicon glyphicon-remove"></span></button>';
                $('#myTab a[href="#tab' + getAttr[1] + '"]').html(tabContent) // tabContent variable, inside the <li>. We change the number also, 1, then 2, then3...
                        .attr('href', '#tab' + (i + 1)); // Same for the href attribute

                $('div.tab-content div#tab' + getAttr[1]).html('<p>Content tab ' + (i + 1) + '</p>') // We do the same for all <div> from <div class="tab-content">: we change the number: 1, then 2, then 3...
                        .attr('id', 'tab' + (i + 1)); // Same for the id attribute

                $('#displayElem').html(i+1); // This line is not required (I just display, inside the <div id="messagesAlert"></div> markup, how many tabs there is)
            });

            $('#messagesAlert').html('<div class="alert alert-danger" id="alertFadeOut">This tab has been deleted!</div>'); // Message saying that the tab has been deleted
        }
        return false;
    }

       /* $("#myTab a").click(function(e){
            e.preventDefault();
            $(this).tab('show');
        });
        $("#myTab2 a").click(function(e){
            e.preventDefault();
            $(this).tab('show');
        });*/
        var trees = [".data-tree",".file-viewer"];


        createJStree(trees);


         /*------------------------------handling changes-----------------------*/

        $('.tree-browser').bind("DOMSubtreeModified",function(){
           // $('li').removeClass('jstree-closed').addClass('jstree-open');
            $('.tree-browser').bind("create_node",function(e,data){
                console.log('hi');
            });
           // $('li').attr("aria-expanded","true");


            if(($('.jstree-container-ul').height())>'720'){
                $('body').css("overflow-y","auto");
            }
            else{
                $('body').css("overflow-y","hidden");
            }
        });

        $('.data-tree,.file-viewer').bind("DOMSubtreeModified",function(){

            var len = $('.data-tree li,.file-viewer li').length;
            if(len===0){
                 $('#reset').prop("disabled",true);
            }
            else{
                 $('#reset').prop("disabled",false);
             }
        });

         $('.data-tree').bind("DOMSubtreeModified",function(){
            var len = $('.data-tree li').length;
            if(len===0){
                $('#submit').prop("disabled",true);
                $( "#buildTree" ).prop( "disabled", true );
                $( "#copyto" ).prop( "disabled", true );

            }
            else{
                $('#submit').prop("disabled",false);
            }
        });

        $('.file-viewer').bind("DOMSubtreeModified",function(){
            var len = $('.file-viewer li').length;
            if(len===0){
                $('#create').prop("disabled",false);
                $('#save').prop("disabled",true);

            }
            else{
                $('#create').prop("disabled",true);
                $('#save').prop("disabled",false);

            }
            $('#savechange').removeClass('glyphicon-floppy-saved').addClass('glyphicon-floppy-save');

            /*------------------------set local storage-------------------------------------*/

            $(function() {
                localStorage["state"] = JSON.stringify($(".data-tree").html());
                localStorage["state2"] = JSON.stringify($('.file-viewer').html());
            });
        });

    /*------------------------Reset button-------------------------------------*/
        $('#reset').click(function() {
            bootbox.confirm("Are you sure want to reset?", function(result) {
                if(result) {
                    $('.file-viewer').jstree("destroy").empty();
                    $('.data-tree').jstree("destroy").empty();
                    $( "#reset" ).prop( "disabled", true );
                    $('#guide').css("display","none");
                    $('#q').val("");
                    createJStree(trees);

                }
            });
        });


    /*------------------------Cookie handling-------------------------------------*/

        var Cookie = readCookie();
        hasCookie(Cookie);

    /*------------------------Guide handling-------------------------------------*/

        $( "#reset" ).prop( "disabled", true );
        $('#next').click(function(){
            $('#step1').fadeOut(300);
            $('#step2').fadeOut(300);
            $('#step3').fadeOut(300);

            $('#step4').css("display","inline-block");
            setTimeout(function(){
               // $('#step2').fadeOut(300);

            }, 5000);
            Cookie = readCookie();
        });

        $('#next4').click(function(){
            $('#step4').fadeOut(300);
            $('#step5').css("display","inline-block");
            setTimeout(function(){
                // $('#step2').fadeOut(300);

            }, 5000);
            Cookie = readCookie();
        });
        $('#next5').click(function(){
            $('#step5').fadeOut(300);
            $('#step6').css("display","inline-block");
            setTimeout(function(){
                // $('#step2').fadeOut(300);

            }, 5000);
            Cookie = readCookie();
        });
        $('#next6').click(function(){
            $('#step6').fadeOut(300);
            //$('#step6').css("display","inline-block");
            setTimeout(function(){
                // $('#step2').fadeOut(300);

            }, 5000);
            Cookie = readCookie();
        });

        /*$('#create').click(function(){
            if(!(hasCookie(Cookie))) {
                $('#step1').fadeOut(300);
                $('#step2').css("display", "inline-block");
            }
            Cookie = readCookie();
        })*/



        /*------------------------------handling localStorage-----------------------*/
        /*if (localStorage["key"] != null || localStorage['Key2'] != null) {

            var contentsOfOldDiv = JSON.parse(localStorage["Key"]);
            $(".data-tree").html(contentsOfOldDiv);
            var contentsOfOldDiv2 = JSON.parse(localStorage["Key2"]);
            $(".file-viewer").html(contentsOfOldDiv2);

            console.log(contentsOfOldDiv);
            console.log(contentsOfOldDiv2);
        }
        else{
            createJStree(trees);


        }*/

     /*-----------------------------------Loader-----------------------------------*/

        $('.loader').fadeOut();
    });
    var resultsArray = [];
    var save_tree = [];

    /*------------------------save button-------------------------------------*/

    $('#save').click(function(){
        /*-------save tree in DB/json file---------*/

        var contentsOfOldDiv = JSON.parse(localStorage["Key"]);
        $(".file-viewer").html(contentsOfOldDiv);


       /* save_tree = (($('.file-viewer ul')));
        console.log(save_tree);
        $('.data-tree').jstree();
            $('.data-tree').appendChild(save_tree);
        //var newfile =
        */



    });
    $('#saveName').click(function(){

        var name ="treeName - "+$('#treeName').val();

            /*-------save tree in local storage---------*/
            localStorage[name] = JSON.stringify($(".file-viewer").html());
        $('#savechange').removeClass('glyphicon-floppy-save').addClass('glyphicon-floppy-saved');
        $( "#save" ).prop( "disabled", true );
        $('#save').blur();


    });

    /*------------------------open button-------------------------------------*/

    $('#open').click(function(){
        /*-------get tree from local storage---------*/
        for ( var i = 0, len = localStorage.length; i < len; ++i ) {
            console.log( localStorage.getItem( localStorage.key( i ) ) );
        }
        $('.list').empty();


        var str = '<h3>Choose Your Tree</h3>';
        $('.list').append(str);
        for (var key in localStorage){
            if(key.toString().includes("treeName")){

                var name = key.toString().substring(11, key.length);
                $('.list').append('<li><button class="get-tree">'+name+'</button><a class="deletetree">X</a></li>');

            }
            console.log(key)
        }



         $('#open').blur();


    });
    $('.list li>button.get-tree').click(function(){
       debugger
    });
    $('.get-tree').click(function(){
        debugger
    });
    $('.get-tree').on('click',function(){
         //var temp = $(this).sibling();
        debugger

    });
    $('.deletetree').on('click',function(){
        console.log('delete');
        //var temp = $(this).sibling();
        debugger
        localStorage.removeItem(key);

    });
    /*-----------------------------------search handling-----------------------------------*/
    $("#s").submit(function (e) {
        e.preventDefault();
        var searchResult = $('.data-tree').jstree('search', $("#q").val());
       // $( ".jstree-search" ).css( "color", "green");
        var $j_object = $(".jstree-search").parent();
        //alert($j_object.size());
        console.log($j_object);
        var classSearch = '.jstree-search';
        resultsArray = $(classSearch).parent();
        console.log(resultsArray.length);
        console.log(resultsArray);
        $('#s').blur();
        $('#submit').blur();
        if(($('#q').val())==='') {
            $( "#buildTree" ).prop( "disabled", true );
        }
        else{
            $( "#buildTree" ).prop( "disabled", false );
        }


    });
    /*------------------------copy to right button-------------------------------------*/

    $('#copyto').click(function(){
        /*-------save tree in DB/json file---------*/

        $('.file-viewer ul').empty();
        $(".data-tree ul").clone().appendTo('.file-viewer');
        //$(resultsArray).appendTo('.file-viewer ul');

      /*  $('.data-tree').jstree("destroy").empty();
        var trees = [".data-tree"];
        createJStree(trees);
*/

        //var newfile =
        $('#copyto').blur();


    });
    /*-----------------------------------build tree-----------------------------------*/

    $("#buildTree").click(function(){

       // $('.data-tree').jstree();
       // $('.data-tree').appendChild(save_tree);
        $('.data-tree ul').empty();
            $(resultsArray).appendTo('.data-tree ul');


        $( ".jstree-search" ).css({
            'color' : 'black',
            'font-weight' : '400'
         });
        $('#q').val('');
        $( "#copyto" ).prop( "disabled", false );

        //$('.data-tree').jstree("destroy").empty();


    });
    /*----------------------Cookie handling Functions-----------------------------*/
        function hasCookie(Cookie){
            if (Cookie) {
                $('.guide').css("display","none");

                return true;
            }
            else {
                createCookie('admin', 'adminCookie', 7);
                return false;
            }
        }
        function readCookie(){
            return document.cookie;
        }
        function createCookie(name,value,days) {
            if (days) {
                var date = new Date();
                date.setTime(date.getTime()+(days*24*60*60*1000));
                var expires = "; expires="+date.toGMTString();
            }
            else var expires = "";
            document.cookie = name+"="+value+expires+"; path=/";
        }



    /*------------------------Create Jstree objects-------------------------------------*/

    function createJStree(trees){
        trees.forEach(function(value){
            var node = $(value).jstree({
                'core': {
                    "check_callback": true,
                    'data': [
                    ]
                },
                "plugins": [
                    "contextmenu", "dnd", "search",
                    "state", "types", "wholerow"
                ],
                rules:{
                  multitree:true,
                    always_copy : true
                }
            });
         })
        return true;


    }
/*----------------------------------------------------------------------------*/

</script>